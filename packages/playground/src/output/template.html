<html class="w-full h-full">
<script type="importmap"><!--IMPORT_MAP--></script>

<body id="body" class="w-full h-full m-0 p-0">
    <div class="w-full h-full flex flex-col">
        <div id="preview-container" class="flex-grow">
            <div id="preview-background" class="flex flex-1 p-1 rounded">
                <div class="relative flex flex-1">
                    <div id="app" class="w-full h-full absolute inset-0"></div>
                </div>
            </div>
        </div>

        <div id="console-container" class="flex-grow pt-2">
            <div id="eruda-container"></div>
        </div>
    </div>
</body>

<link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.css'/>

<script src="https://cdn.jsdelivr.net/npm/@unocss/runtime"></script>

<script type="module">
    import NProgress from 'nprogress';
    import eruda from "eruda";
    import { usarTerminal } from '@es-js/terminal';

    (async () => {
        NProgress.start()

        var flowchartSvg = `<!--FLOWCHART_SVG-->`

        let scriptEls = []

        window.process = { env: {} }
        window.__modules__ = {}

        window.__export__ = (mod, key, get) => {
            Object.defineProperty(mod, key, {
                enumerable: true,
                configurable: true,
                get
            })
        }

        window.__dynamic_import__ = key => {
            return Promise.resolve(window.__modules__[key])
        }

        async function handle_message(ev) {
            let { action, cmd_id, args } = ev.data;

            const send_message = (payload) => parent.postMessage( { ...payload }, ev.origin);
            const send_reply = (payload) => send_message({ ...payload, cmd_id });
            const send_ok = () => send_reply({ action: 'cmd_ok' });
            const send_error = (message, stack) => send_reply({ action: 'cmd_error', message, stack });

            if (action === 'eval') {
                try {
                    if (scriptEls.length) {
                        scriptEls.forEach(el => {
                            document.head.removeChild(el)
                        })
                        scriptEls.length = 0
                    }

                    let { script: scripts } = ev.data.args

                    if (typeof scripts === 'string') scripts = [scripts]

                    for (const script of scripts) {
                        const scriptEl = document.createElement('script')
                        scriptEl.setAttribute('type', 'module')
                        // send ok in the module script to ensure sequential evaluation
                        // of multiple proxy.eval() calls
                        const done = new Promise((resolve) => {
                            window.__next__ = resolve
                        })
                        scriptEl.innerHTML = script + `\nwindow.__next__()`
                        document.head.appendChild(scriptEl)
                        scriptEl.onerror = err => send_error(err.message, err.stack)
                        scriptEls.push(scriptEl)
                        await done
                    }

                    send_ok()
                } catch (e) {
                    send_error(e.message, e.stack);
                }
            } else if (action === 'HIDE_PREVIEW') {
                _hidePreview(args)
            } else if (action === 'HIDE_CONSOLE') {
                _hideConsole(args)
            } else if (action === 'previewException') {
                window._previewException(...args)
            } else if (action === 'PREVIEW') {
                window._preview(args)
            } else if (action === 'DARK_MODE') {
                window._darkMode(args)
            }
        }

        window.addEventListener('message', handle_message, false);

        window.addEventListener('esjs-prueba-success', (args) => {
            parent.postMessage({ action: 'esjs-prueba-success', data: JSON.stringify(args.detail) }, '*');
        })

        window.addEventListener('esjs-prueba-error', (args) => {
            parent.postMessage({ action: 'esjs-prueba-error', data: JSON.stringify(args.detail) }, '*');
        })

        window.addEventListener('esjs-pruebas-finished', (args) => {
            parent.postMessage({ action: 'esjs-pruebas-finished', data: JSON.stringify(args.detail) }, '*');
        })

        window.onerror = function (msg, url, lineNo, columnNo, error) {
            // ignore errors from import map polyfill - these are necessary for
            // it to detect browser support
            if (msg.includes('module specifier “vue”')) {
                // firefox only error, ignore
                return false
            }
            if (msg.includes('Module specifier, \'vue')) {
                // Safari only
                return false
            }
            try {
                parent.postMessage({ action: 'error', value: error }, '*');
            } catch (e) {
                parent.postMessage({ action: 'error', value: msg }, '*');
            }
        }

        window.onload = function () {
            NProgress.done()
        }

        window.addEventListener("unhandledrejection", event => {
            if (event.reason.message.includes('Cross-origin')) {
                event.preventDefault()
                return
            }
            try {
                parent.postMessage({ action: 'unhandledrejection', value: event.reason }, '*');
            } catch (e) {
                parent.postMessage({ action: 'unhandledrejection', value: event.reason.message }, '*');
            }
        });

        function _initEruda() {
            const erudaContainerElement = document.getElementById('eruda-container')

            const style = Object.assign(document.createElement('link'), {
                rel: 'stylesheet',
                href: `/eruda.css`
            });

            eruda.init({
                container: erudaContainerElement,
                tool: ['console'],
            });

            eruda.show();
            eruda._shadowRoot.appendChild(style);
        }

        function _hideConsole(value) {
            const consoleElement = document.getElementById('console-container');

            if (value) {
                consoleElement.classList.add('hidden');
            } else {
                consoleElement.classList.remove('hidden');
            }

            usarTerminal().fitTerminal()
        }

        function _hidePreview(value) {
            const previewElement = document.getElementById('preview-container');
            const erudaDevToolsElement = eruda._$el[0].getElementsByClassName('eruda-dev-tools');

            if (value) {
                previewElement.style.display = 'none';
                previewElement.style.flex = '0 0 0';

                erudaDevToolsElement[0].style.height = '100%';
            } else {
                previewElement.style.display = 'flex';
                previewElement.style.flex = '1 1 0';

                erudaDevToolsElement[0].style.height = '50%';
            }

            usarTerminal().fitTerminal()
        }

        window._handleInfiniteLoopException = function (error) {
            console.warn('¡Advertencia!: Se ha detectado un bucle infinito');
            console.error(error);
        }

        window._previewException = function (line, column, message) {
            console.warn(`¡Advertencia!: Se ha detectado un error en la línea ${line}`);
            // console.error(error.toString());
        }

        window._preview = function(value) {
            switch (value) {
                case 'terminal':
                    return _previewTerminal();
                case 'flowchart':
                    return _previewFlowchart();
                case 'html':
                    return _previewHtml();
            }
        }

        window._darkMode = function(isDark) {
            const previewWrapperElement = document.getElementById('preview-background');
            if (previewWrapperElement) {
                previewWrapperElement.style.backgroundColor = isDark ? '#121212' : '#ffffff';
                previewWrapperElement.style.border = `1px solid ${isDark ? 'rgb(34, 34, 34)' : 'rgb(221, 225, 227)'}`
            }

            usarTerminal().xterm.options.theme = isDark ? {
                "foreground": "#e5e5e5",
                "background": "#121212",
                "cursor": "#c7d2fe",
                "black": "#212121",
                "brightBlack": "#424242",
                "red": "#b7141f",
                "brightRed": "#e83b3f",
                "green": "#457b24",
                "brightGreen": "#7aba3a",
                "yellow": "#f6981e",
                "brightYellow": "#ffea2e",
                "blue": "#134eb2",
                "brightBlue": "#54a4f3",
                "magenta": "#560088",
                "brightMagenta": "#aa4dbc",
                "cyan": "#0e717c",
                "brightCyan": "#26bbd1",
                "white": "#efefef",
                "brightWhite": "#d9d9d9"
            } : {
                "foreground": "#232322",
                "background": "#ffffff",
                "cursor": "#c7d2fe",
                "black": "#212121",
                "brightBlack": "#424242",
                "red": "#b7141f",
                "brightRed": "#e83b3f",
                "green": "#457b24",
                "brightGreen": "#7aba3a",
                "yellow": "#f6981e",
                "brightYellow": "#ffea2e",
                "blue": "#134eb2",
                "brightBlue": "#54a4f3",
                "magenta": "#560088",
                "brightMagenta": "#aa4dbc",
                "cyan": "#0e717c",
                "brightCyan": "#26bbd1",
                "white": "#efefef",
                "brightWhite": "#d9d9d9"
            };

            const erudaDevToolsElement = eruda._$el[0].getElementsByClassName('eruda-dev-tools');
            erudaDevToolsElement[0].style.border = `1px solid ${isDark ? 'rgb(34, 34, 34)' : 'rgb(221, 225, 227)'}`

            eruda._$el[0].style.colorScheme = isDark ? 'dark' : 'light';
            eruda._devTools.config.set('theme', isDark ? 'Material Darker' : 'Light');
        }

        function _previewTerminal() {
            const app = document.getElementById('app');
            app.innerHTML = '';

            const terminalElement = document.createElement('es-terminal');
            terminalElement.classList.add('w-full', 'h-full', 'absolute', 'inset-0');
            document.getElementById('app').appendChild(terminalElement);

            usarTerminal().fitTerminal()
        }

        function _previewFlowchart() {
            const app = document.getElementById('app');
            app.innerHTML = '';

            app.innerHTML = flowchartSvg;

            app.classList.add('overflow-auto');
        }

        function _previewHtml() {
            _setBodyColor('bg-white')

            const app = document.getElementById('app');
            app.innerHTML = '';

            const htmlToInject = `${options.customHtml}`
            const template = html`${htmlToInject}`
            template(app)
        }

        function _setBodyColor(color) {
            const bodyElement = document.getElementById('body');
            bodyElement.classList.forEach((className) => {
                if (className.startsWith('bg-')) {
                    bodyElement.classList.remove(className);
                }
            })
            bodyElement.classList.add(color);
        }

        await _initEruda()
    })()
</script>
</html>
