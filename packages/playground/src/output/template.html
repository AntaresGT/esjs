<html class="w-full h-full <!--COLOR_SCHEME-->" hidden>
<script type="importmap"><!--IMPORT_MAP--></script>

<body id="body" class="w-full h-full m-0 p-0">
    <div class="w-full h-full flex flex-col space-y-2">
        <div id="preview-container" class="flex-grow">
            <div  class="flex flex-1 flex-col border border-gray-300 dark:border-gray-800 rounded">
                <div class="flex flex-row items-center bg-gray-100 dark:bg-gray-800 border-b border-gray-300 dark:border-gray-800 rounded-t">
                    <div class="flex flex-row items-center px-2 py-1 space-x-1 text-sm bg-gray-100 hover:bg-gray-200 text-gray-900 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-white rounded-tl cursor-pointer">
                        <span>Terminal</span>
                    </div>
                </div>

                <div id="preview-background" class="flex flex-grow p-1 bg-white dark:bg-[#121212]">
                    <div class="relative flex flex-1">
                        <es-terminal class="w-full h-full absolute inset-0"></es-terminal>
                    </div>
                </div>
            </div>
        </div>

        <div id="console-container" class="flex-grow">
            <div id="eruda-container"></div>
        </div>
    </div>
</body>

<link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.css'/>
<link rel='stylesheet' href='/eruda.css'/>

<script type="module">
    import NProgress from 'nprogress';
    import eruda from "eruda";
    import { usarTerminal } from '@es-js/terminal';
    import { setup } from 'twind/shim'

    (async () => {
        NProgress.start()

        var flowchartSvg = `<!--FLOWCHART_SVG-->`
        var activePreviewTab = `<!--ACTIVE_PREVIEW_TAB-->`
        var erudaSize = 50

        let scriptEls = []

        window.process = { env: {} }
        window.__modules__ = {}

        window.__export__ = (mod, key, get) => {
            Object.defineProperty(mod, key, {
                enumerable: true,
                configurable: true,
                get
            })
        }

        window.__dynamic_import__ = key => {
            return Promise.resolve(window.__modules__[key])
        }

        async function handle_message(ev) {
            let { action, cmd_id, args } = ev.data;

            const send_message = (payload) => parent.postMessage( { ...payload }, ev.origin);
            const send_reply = (payload) => send_message({ ...payload, cmd_id });
            const send_ok = () => send_reply({ action: 'cmd_ok' });
            const send_error = (message, stack) => send_reply({ action: 'cmd_error', message, stack });

            if (action === 'eval') {
                try {
                    if (scriptEls.length) {
                        scriptEls.forEach(el => {
                            document.head.removeChild(el)
                        })
                        scriptEls.length = 0
                    }

                    let { script: scripts } = ev.data.args

                    if (typeof scripts === 'string') scripts = [scripts]

                    for (const script of scripts) {
                        const scriptEl = document.createElement('script')
                        scriptEl.setAttribute('type', 'module')
                        // send ok in the module script to ensure sequential evaluation
                        // of multiple proxy.eval() calls
                        const done = new Promise((resolve) => {
                            window.__next__ = resolve
                        })
                        scriptEl.innerHTML = script + `\nwindow.__next__()`
                        document.head.appendChild(scriptEl)
                        scriptEl.onerror = err => send_error(err.message, err.stack)
                        scriptEls.push(scriptEl)
                        await done
                    }

                    send_ok()
                } catch (e) {
                    send_error(e.message, e.stack);
                }
            } else if (action === 'HIDE_PREVIEW') {
                _togglePreview(args)
            } else if (action === 'HIDE_CONSOLE') {
                // _hideEruda()
            } else if (action === 'previewException') {
                window._previewException(...args)
            } else if (action === 'PREVIEW') {
                // console.warn(['----- DEPRECATED -----', 'Please use PREVIEW_TAB instead'])
            } else if (action === 'PREVIEW_TAB') {
                _previewTab(args)
            } else if (action === 'DARK_MODE') {
                _darkMode(args)
            }
        }

        window.addEventListener('message', handle_message, false);

        window.addEventListener('esjs-prueba-success', (args) => {
            parent.postMessage({ action: 'esjs-prueba-success', data: JSON.stringify(args.detail) }, '*');
        })

        window.addEventListener('esjs-prueba-error', (args) => {
            parent.postMessage({ action: 'esjs-prueba-error', data: JSON.stringify(args.detail) }, '*');
        })

        window.addEventListener('esjs-pruebas-finished', (args) => {
            parent.postMessage({ action: 'esjs-pruebas-finished', data: JSON.stringify(args.detail) }, '*');
        })

        window.onerror = function (msg, url, lineNo, columnNo, error) {
            // ignore errors from import map polyfill - these are necessary for
            // it to detect browser support
            if (msg.includes('module specifier “vue”')) {
                // firefox only error, ignore
                return false
            }
            if (msg.includes('Module specifier, \'vue')) {
                // Safari only
                return false
            }
            try {
                parent.postMessage({ action: 'error', value: error }, '*');
            } catch (e) {
                parent.postMessage({ action: 'error', value: msg }, '*');
            }
        }

        window.onload = function () {
            NProgress.done()
        }

        window.addEventListener("unhandledrejection", event => {
            if (event.reason.message.includes('Cross-origin')) {
                event.preventDefault()
                return
            }
            try {
                parent.postMessage({ action: 'unhandledrejection', value: event.reason }, '*');
            } catch (e) {
                parent.postMessage({ action: 'unhandledrejection', value: event.reason.message }, '*');
            }
        });

        function _initTwind() {
            setup({
                mode: 'silent',
                darkMode: 'class',
            })
        }

        function _initEruda() {
            const erudaContainerElement = document.getElementById('eruda-container')

            if (!erudaContainerElement) {
                return
            }

            eruda.init({
                container: erudaContainerElement,
                tool: ['console'],
                autoScale: true,
                useShadowDom: false,
                defaults: {
                    displaySize: erudaSize,
                    theme: 'Light',
                    transparency: 100,
                },
            });

            eruda.add(function (eruda) {
                class Flowchart extends eruda.Tool {
                    constructor() {
                        super()
                        this.name = 'flowchart'
                    }
                    init($el) {
                        super.init($el)
                        $el.html(flowchartSvg)
                    }
                    show() {
                        super.show()
                    }
                    hide() {
                        super.hide()
                    }
                    destroy() {
                        super.destroy()
                    }
                }

                return new Flowchart();
            });
            eruda.remove('settings')
            eruda.show();
            renameErudaTabs()
            setupErudaConsoleClickHandler()
            setupErudaFlowchartClickHandler()

           switch (activePreviewTab) {
               case 'console':
                   _openConsole()
                   break;
               case 'flowchart':
                   _openFlowchart()
                   break;
               case 'hidden':
                   _hideEruda()
                   break;
           }
        }

        function renameErudaTabs() {
            const erudaTabs = document.querySelectorAll('.luna-tab-item');

            if (erudaTabs && erudaTabs.length) {
                erudaTabs[0].innerHTML = 'Consola';
                erudaTabs[1].innerHTML = 'Diagrama de flujo';
            }
        }

        function setupErudaConsoleClickHandler() {
            const erudaConsoleTab = document.querySelector('.luna-tab-item[data-id="console"]');

            if (!erudaConsoleTab) {
                return;
            }

            erudaConsoleTab.addEventListener('click', handleErudaConsoleClick)
        }

        function setupErudaFlowchartClickHandler() {
            const erudaFlowchartTab = document.querySelector('.luna-tab-item[data-id="flowchart"]');

            if (!erudaFlowchartTab) {
                return;
            }

            erudaFlowchartTab.addEventListener('click', handleErudaFlowchartClick)
        }

        function handleErudaConsoleClick() {
            if (activePreviewTab === 'console') {
                _hideEruda()
            } else {
                _openConsole()
            }
        }

        function handleErudaFlowchartClick() {
            if (activePreviewTab === 'flowchart') {
                _hideEruda()
            } else {
                _openFlowchart()
            }
        }

        function _openEruda() {
            eruda.get().config.set('displaySize', erudaSize)

            const consoleElement = document.getElementById('console-container');
            consoleElement.classList.remove('h-eruda-tab');
            consoleElement.classList.add('flex-grow');

            const lunaTabSliderElement = document.querySelector('.luna-tab-slider');
            lunaTabSliderElement.style.display = 'inline-block';
        }

        function _openConsole() {
            activePreviewTab = 'console';
            parent.postMessage({ action: 'activePreviewTab', data: 'console' }, '*');

            eruda.show('console')
            _openEruda()

            const consoleElement = document.getElementById('console-container');
            consoleElement.classList.remove('h-eruda-tab');
            consoleElement.classList.add('flex-grow')

            usarTerminal().fitTerminal()
        }

        function _openFlowchart() {
            activePreviewTab = 'flowchart';
            parent.postMessage({ action: 'activePreviewTab', data: 'flowchart' }, '*');

            eruda.show('flowchart')
            _openEruda()

            const consoleElement = document.getElementById('console-container');
            consoleElement.classList.remove('h-eruda-tab');
            consoleElement.classList.add('flex-grow')

            usarTerminal().fitTerminal()
        }

        function _hideEruda() {
            activePreviewTab = 'hidden'
            parent.postMessage({ action: 'activePreviewTab', data: 'hidden' }, '*');

            eruda.get().config.set('displaySize', 1)

            const consoleElement = document.getElementById('console-container');
            consoleElement.classList.remove('flex-grow')
            consoleElement.classList.add('h-eruda-tab');

            const lunaTabsElements = document.querySelectorAll('.luna-tab-item');
            lunaTabsElements.forEach((element) => {
                element.classList.remove('luna-tab-selected')
            })

            const lunaTabSliderElement = document.querySelector('.luna-tab-slider');
            lunaTabSliderElement.style.display = 'none';
        }

        function _togglePreview(value) {
            const previewElement = document.getElementById('preview-container');

            if (value) {
                previewElement.style.display = 'none';
                previewElement.style.flex = '0 0 0';

                erudaSize = 100
            } else {
                previewElement.style.display = 'flex';
                previewElement.style.flex = '1 1 0';

                erudaSize = 50
            }

            if (activePreviewTab !== 'hidden') {
                _openEruda()
            }

            usarTerminal().fitTerminal()
        }

        window._handleInfiniteLoopException = function (error) {
            console.warn('¡Advertencia!: Se ha detectado un bucle infinito');
            console.error(error);
        }

        window._previewException = function (line, column, message) {
            console.warn(`¡Advertencia!: Se ha detectado un error en la línea ${line}`);
            // console.error(error.toString());
        }

        function _previewTab(value) {
            if (value === activePreviewTab) {
                return;
            }

            activePreviewTab = value;

            switch (value) {
                case 'console':
                    return _openConsole();
                case 'flowchart':
                    return _openFlowchart();
                case 'hidden':
                    return _hideEruda();
            }
        }

        function _darkMode(isDark) {
            const htmlElement = document.getElementsByTagName('html')[0];
            if (htmlElement) {
                htmlElement.classList.remove(isDark ? 'light' : 'dark');
                htmlElement.classList.add(isDark ? 'dark' : 'light');
            }

            if (eruda && eruda.get()) {
                eruda.get().config.set('theme', isDark ? 'Material Darker' : 'Light');
            }

            setTerminalTheme();
        }

        function setTerminalTheme() {
            const isDark = document.getElementsByTagName('html')[0].classList.contains('dark');

            usarTerminal().xterm.options.theme = isDark ? {
                "foreground": "#e5e5e5",
                "background": "#121212",
                "cursor": "#c7d2fe",
                "black": "#212121",
                "brightBlack": "#424242",
                "red": "#b7141f",
                "brightRed": "#e83b3f",
                "green": "#457b24",
                "brightGreen": "#7aba3a",
                "yellow": "#f6981e",
                "brightYellow": "#ffea2e",
                "blue": "#134eb2",
                "brightBlue": "#54a4f3",
                "magenta": "#560088",
                "brightMagenta": "#aa4dbc",
                "cyan": "#0e717c",
                "brightCyan": "#26bbd1",
                "white": "#efefef",
                "brightWhite": "#d9d9d9"
            } : {
                "foreground": "#232322",
                "background": "#ffffff",
                "cursor": "#c7d2fe",
                "black": "#212121",
                "brightBlack": "#424242",
                "red": "#b7141f",
                "brightRed": "#e83b3f",
                "green": "#457b24",
                "brightGreen": "#7aba3a",
                "yellow": "#f6981e",
                "brightYellow": "#ffea2e",
                "blue": "#134eb2",
                "brightBlue": "#54a4f3",
                "magenta": "#560088",
                "brightMagenta": "#aa4dbc",
                "cyan": "#0e717c",
                "brightCyan": "#26bbd1",
                "white": "#efefef",
                "brightWhite": "#d9d9d9"
            };
        }

        function _initTerminal() {
            setTerminalTheme();
            usarTerminal().fitTerminal()
        }

        _initTwind();
        _initTerminal();
        await _initEruda();
    })()
</script>
</html>
